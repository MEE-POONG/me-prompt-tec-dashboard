// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ---------------- Enums ----------------
enum Role {
  admin
  staff
  student
  viewer
}

enum CoopType {
  coop
  internship
  part_time
}

enum ProjectStatus {
  planning
  in_progress
  completed
  on_hold
}

enum MediaOwnerType {
  company
  project
  member
  intern
  mou
}

enum MediaType {
  image
  video
  file
}

// ---------------- Composite Types (Embedded) ----------------
type Name {
  first   String
  last    String
  display String?
}

type Address {
  line1      String?
  line2      String?
  district   String?
  province   String?
  postalCode String?
  country    String? @default("TH")
}

type Social {
  facebook  String?
  x         String?
  instagram String?
  linkedin  String?
  github    String?
  website   String?
}

type Link {
  label String
  url   String
}

type Skill {
  name  String
  level String? // "beginner" | "intermediate" | "advanced" | "expert"
}

type Education {
  school    String
  faculty   String?
  major     String?
  degree    String? // "Diploma" | "Bachelor" | "Master" | "PhD" | "Other"
  startDate DateTime?
  endDate   DateTime?
  gpa       Float?
}

type Experience {
  company          String?
  title            String?
  startDate        DateTime?
  endDate          DateTime?
  responsibilities String[]
  techStack        String[]
}

type Attachment {
  type MediaType @default(image)
  url  String
  alt  String?
}

type Hero {
  title    String?
  subtitle String?
  ctaText  String?
  ctaLink  String?
}

type SEO {
  siteTitle       String?
  siteDescription String?
  keywords        String[]
}

type Service {
  name     String
  summary  String?
  features String[]
  icon     String?
}

type ContactInfo {
  email   String?
  phone   String?
  address Address?
}

type Resume {
  summary     String?
  skills      Skill[]
  educations  Education[]
  experiences Experience[]
  projects    ResumeProject[]
  links       Link[]
}

type ResumeProject {
  name        String
  description String?
  techStack   String[]
  links       Link[]
}

// ---------------- Core Models ----------------

// ผู้ใช้งานหลังบ้าน
model User {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  email        String  @unique
  passwordHash String
  role         Role    @default(viewer)
  isActive     Boolean @default(false)
  verifyToken   String?
  tokenExpire   DateTime?
  isVerified   Boolean  @default(false)

  name     String? // ชื่อ-นามสกุล (ใช้แทน fullName)
  phone    String? // เบอร์โทร
  position String? // ตำแหน่ง
  // ------------------------
  // โปรไฟล์ที่เชื่อม (อย่างใดอย่างหนึ่งหรือว่างได้)
  memberId String? @db.ObjectId
  member   Member? @relation(fields: [memberId], references: [id])

  internId String? @db.ObjectId
  intern   Intern? @relation(fields: [internId], references: [id])

  // relation: Contact messages handled by this user
  handledMessages ContactMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
}

// singleton โปรไฟล์บริษัท
model Company {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String    @default("ME PROMPT TECHNOLOGY COMPANY LIMITED")
  tagline   String?
  about     String?
  addresses Address[]
  phones    String[]
  emails    String[]
  socials   Social?
  services  Service[]
  hero      Hero?
  seo       SEO?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// สมาชิกทีม/พนักงาน
model Member {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  name       Name
  title      String?
  department String?
  bio        String?
  photo      String?
  socials    Social?
  skills     Skill[]
  slug       String  @unique
  // [NEW] งานที่ได้รับมอบหมาย
  assignedTasks TaskAssignee[]
  // relation: Projects ผ่าน join
  projectLinks ProjectMember[]

  // relation: Users that link to this member
  users User[]

  // relation: MOU contracts signed by this member
  mouContracts MOU[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// นักศึกษา Coop/ฝึกงาน (มีหน้า portfolio ของตัวเอง)
model Intern {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  name       Name
  university String  @default("มหาวิทยาลัยเทคโนโลยีราชมงคลอีสาน")
  faculty    String? @default("คณะบริหารธุรกิจ")
  major      String? @default("สารสนเทศทางคอมพิวเตอร์")
  studentId  String?

  // ✅ เพิ่มฟิลด์รุ่น (Generation) ตรงนี้ครับ
  gen String @default("6")

  coopType      CoopType     @default(coop)
  contact       ContactInfo?
  resume        Resume?
  avatar        String?
  portfolioSlug String       @unique
  status        String       @default("published") // draft|published|archived

  // relation: Projects ผ่าน join
  projectLinks ProjectIntern[]

  // relation: Users that link to this intern
  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ผลงาน/โปรเจกต์บริษัท (หน้า Portfolio)
model Project {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  slug         String        @unique
  summary      String?
  description  String?
  status       ProjectStatus @default(in_progress)
  startDate    DateTime?
  endDate      DateTime?
  clientName   String?
  clientSector String?
  tags         String[]
  techStack    String[]
  cover        String?
  gallery      Attachment[]
  links        Link[]
  featured     Boolean       @default(false)

  // relations via join
  memberLinks ProjectMember[]
  internLinks ProjectIntern[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([featured])
  @@index([title])
}

// ความร่วมมือ/MOU
model MOU {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  university   String
  faculty      String?
  department   String?
  signedDate   DateTime
  expiryDate   DateTime?
  contactName  String?
  contactEmail String?
  contactPhone String?

  // ผู้แทนบริษัทที่ลงนาม
  companyRep   Member? @relation(fields: [companyRepId], references: [id])
  companyRepId String? @db.ObjectId

  fileUrl  String?
  notes    String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([university, faculty, signedDate])
}

// ข้อความติดต่อจากหน้าเว็บ
model ContactMessage {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String?
  date         DateTime?
  email        String?
  phone        String?
  subject      String?
  message      String
  source       String    @default("website") // website|portfolio|intern-page|other
  resumeUrl    String?
  portfolioUrl String?

  handledById String? @db.ObjectId
  handledBy   User?   @relation(fields: [handledById], references: [id])

  status String @default("new") // new|in-progress|done

  // ✅ เพิ่ม isStarred ตรงนี้
  isStarred Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
}

// สื่อ/ไฟล์ ที่ผูกกับเอกสารต่างๆ
model MediaAsset {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  ownerType MediaOwnerType
  ownerId   String         @db.ObjectId
  type      MediaType      @default(image)
  url       String
  alt       String?
  tags      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, ownerId])
}

// ---------------- Join Models (Many-to-Many) ----------------
// Prisma + MongoDB ยังไม่มี implicit M2M; ใช้ join collection แทน

model ProjectMember {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  projectId String @db.ObjectId
  memberId  String @db.ObjectId

  project Project @relation(fields: [projectId], references: [id])
  member  Member  @relation(fields: [memberId], references: [id])

  role String? // บทบาทในโปรเจกต์ (PM, Dev, Designer)
  note String?

  @@unique([projectId, memberId]) // ไม่ซ้ำในโปรเจกต์เดียวกัน
}

model ProjectIntern {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  projectId String @db.ObjectId
  internId  String @db.ObjectId

  project Project @relation(fields: [projectId], references: [id])
  intern  Intern  @relation(fields: [internId], references: [id])

  responsibility String?
  note           String?

  @@unique([projectId, internId])
}

// ตารางเก็บตำแหน่งงานที่เปิดรับ (Internship Positions)
model InternshipPosition {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String // ชื่อตำแหน่ง เช่น Frontend Developer
  description String // รายละเอียด
  isOpen      Boolean @default(true) // เปิดรับอยู่หรือไม่

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Partner {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  type        String
  logo        String? // path รูป / URL logo
  website     String?
  facebookUrl String?
  description String?
  status      String  @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Model สำหรับเก็บข้อมูลรูปภาพที่อัพโหลดไปยัง Cloudflare Images
model CloudflareImage {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  cloudflareId     String   @unique // ID ที่ Cloudflare ส่งกลับมา
  filename         String // ชื่อไฟล์ต้นฉบับ
  uploadedBy       String? // อาจเชื่อมกับ User ID ถ้าต้องการ
  publicUrl        String // URL สำหรับเข้าถึงรูปภาพ
  variants         String[] // URL ของ variants ต่างๆ (thumbnail, medium, large)

  // Metadata
  width            Int?
  height           Int?
  format           String? // jpg, png, webp, etc.
  size             Int? // ขนาดไฟล์ (bytes)

  // Reference ไปยัง entity ที่ใช้รูปนี้
  relatedType      String? // "project" | "member" | "intern" | "partner" | etc.
  relatedId        String? @db.ObjectId
  fieldName        String? // "cover" | "avatar" | "logo" | "gallery" etc.

  // จัดการ
  isActive         Boolean  @default(true)
  tags             String[] // tags สำหรับจัดการรูป

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([relatedType, relatedId])
  @@index([uploadedBy])
}


model NewsletterSubscriber {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  source    String   @default("website") // homepage | contact | etc.
  createdAt DateTime @default(now())

  @@index([createdAt])
}
// [NEW] งานย่อยในโปรเจกต์ (Kanban Card)
model Task {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  
  // Tag ที่แสดงบนการ์ด เช่น "Design", "Backend", "Research"
  tag         String?  @default("General")
  
  // สถานะใน Kanban Board (Column ID)
  // ค่าที่แนะนำ: "todo", "inprogress", "review", "done"
  columnId    String   @default("todo")
  
  // ลำดับการเรียงในการ์ด (ถ้าต้องการทำ Drag & Drop แบบจำตำแหน่งเป๊ะๆ)
  order       Int      @default(0)
  
  dueDate     DateTime?

  // ความสัมพันธ์กับ Project
  projectId   String   @db.ObjectId
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // คนที่รับผิดชอบงานนี้ (Assignees)
  assignees   TaskAssignee[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([columnId])
}

// [NEW] ตารางเชื่อมระหว่าง Task กับ Member (ใครรับผิดชอบงานไหน)
model TaskAssignee {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  taskId   String @db.ObjectId
  memberId String @db.ObjectId

  task     Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([taskId, memberId]) // ห้าม assign คนเดิมซ้ำในงานเดิม
}