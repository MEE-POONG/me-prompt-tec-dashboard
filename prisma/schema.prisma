// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// =========================================
// Enums
// =========================================

enum Role {
  admin
  staff
  student
  viewer
}

enum CoopType {
  coop
  internship
  part_time
}

enum ProjectStatus {
  planning
  in_progress
  completed
  on_hold
}

enum MediaOwnerType {
  company
  project
  member
  intern
  mou
}

enum MediaType {
  image
  video
  file
}

// ✅ Enum สำหรับการมองเห็น Project (Private/Public)
enum Visibility {
  PRIVATE
  PUBLIC
}

enum TaskPriority {
  High
  Medium
  Low
}

// =========================================
// Composite Types (Embedded)
// =========================================

type Name {
  first   String
  last    String
  display String?
}

type Address {
  line1      String?
  line2      String?
  district   String?
  province   String?
  postalCode String?
  country    String? @default("TH")
}

type Social {
  facebook  String?
  x         String?
  instagram String?
  linkedin  String?
  github    String?
  website   String?
}

type Link {
  label String
  url   String
}

type Skill {
  name  String
  level String? // "beginner" | "intermediate" | "advanced" | "expert"
}

type Education {
  school    String
  faculty   String?
  major     String?
  degree    String? // "Diploma" | "Bachelor" | "Master" | "PhD" | "Other"
  startDate DateTime?
  endDate   DateTime?
  gpa       Float?
}

type Experience {
  company          String?
  title            String?
  startDate        DateTime?
  endDate          DateTime?
  responsibilities String[]
  techStack        String[]
}

type Attachment {
  type MediaType @default(image)
  url  String
  alt  String?
}

type Hero {
  title    String?
  subtitle String?
  ctaText  String?
  ctaLink  String?
}

type SEO {
  siteTitle       String?
  siteDescription String?
  keywords        String[]
}

type Service {
  name     String
  summary  String?
  features String[]
  icon     String?
}

type ContactInfo {
  email   String?
  phone   String?
  address Address?
}

type Resume {
  summary      String?
  skills       Skill[]
  educations   Education[]
  experiences  Experience[]
  projects     ResumeProject[]
  links        Link[]
}

type ResumeProject {
  name        String
  description String?
  techStack   String[]
  links       Link[]
}

// =========================================
// Core Models (Company & Users)
// =========================================

// ผู้ใช้งานหลังบ้าน (Backend Users)
model User {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  email        String    @unique
  passwordHash String
  role         Role      @default(viewer)
  isActive     Boolean   @default(false)
  verifyToken  String?
  tokenExpire  DateTime?
  isVerified   Boolean   @default(false)

  name     String? // ชื่อ-นามสกุล (ใช้แทน fullName)
  phone    String? // เบอร์โทร
  position String? // ตำแหน่ง
  avatar   String? // รูปโปรไฟล์สำหรับแสดงใน Board

  // Tasks ที่ user ถูก assign (ผ่าน TaskAssignee)
  taskAssignees TaskAssignee[]

  // โปรไฟล์ที่เชื่อม
  memberId String? @db.ObjectId
  member   Member? @relation(fields: [memberId], references: [id])

  internId String? @db.ObjectId
  intern   Intern? @relation(fields: [internId], references: [id])

  // Contact messages handled by this user
  handledMessages ContactMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
}

// singleton โปรไฟล์บริษัท
model Company {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String    @default("ME PROMPT TECHNOLOGY COMPANY LIMITED")
  tagline   String?
  about     String?
  addresses Address[]
  phones    String[]
  emails    String[]
  socials   Social?
  services  Service[]
  hero      Hero?
  seo       SEO?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// สมาชิกทีม/พนักงาน (Public Profile)
model Member {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  name       Name
  title      String?
  department String?
  bio        String?
  photo      String?
  socials    Social?
  skills     Skill[]
  slug       String  @unique

  // relation: Projects ผ่าน join (Public Credits)
  projectLinks ProjectMember[]

  // relation: Users that link to this member
  users User[]

  // relation: MOU contracts signed by this member
  mouContracts MOU[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// นักศึกษา Coop/ฝึกงาน (Public Profile)
model Intern {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  name       Name
  university String  @default("มหาวิทยาลัยเทคโนโลยีราชมงคลอีสาน")
  faculty    String? @default("คณะบริหารธุรกิจ")
  major      String? @default("สารสนเทศทางคอมพิวเตอร์")
  studentId  String?

  gen String @default("6")

  coopType      CoopType     @default(coop)
  contact       ContactInfo?
  resume        Resume?
  avatar        String?
  portfolioSlug String       @unique
  status        String       @default("published") // draft|published|archived

  // relation: Projects ผ่าน join
  projectLinks ProjectIntern[]

  // relation: Users that link to this intern
  users User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ผลงาน/โปรเจกต์บริษัท (Shared Model: Used for Portfolio & Workspace)
model Project {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  title        String
  slug         String        @unique
  summary      String?
  description  String?
  status       ProjectStatus @default(in_progress)
  startDate    DateTime?
  endDate      DateTime?
  clientName   String?
  clientSector String?
  tags         String[]
  techStack    String[]
  cover        String?
  gallery      Attachment[]
  links        Link[]
  featured     Boolean       @default(false)

  // Fields for Internal Workspace
  color            String  @default("#3B82F6") // Hex or Tailwind Class
  isCustomColor    Boolean @default(false)
  internalProgress Int     @default(0) // 0-100
  internalDueDate  String? // String display format ex "Nov 24" or use endDate

  // relations via join (Public Portfolio)
  memberLinks ProjectMember[]
  internLinks ProjectIntern[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  boardActivities BoardActivity[]

  @@index([status])
  @@index([featured])
  @@index([title])
}

// ความร่วมมือ/MOU
model MOU {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  university   String
  faculty      String?
  department   String?
  signedDate   DateTime
  expiryDate   DateTime?
  contactName  String?
  contactEmail String?
  contactPhone String?

  // ผู้แทนบริษัทที่ลงนาม
  companyRep   Member? @relation(fields: [companyRepId], references: [id])
  companyRepId String? @db.ObjectId

  fileUrl  String?
  notes    String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([university, faculty, signedDate])
}

// ข้อความติดต่อจากหน้าเว็บ
model ContactMessage {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  name         String?
  date         DateTime?
  email        String?
  phone        String?
  subject      String?
  message      String
  source       String    @default("website") // website|portfolio|intern-page|other
  resumeUrl    String?
  portfolioUrl String?

  handledById String? @db.ObjectId
  handledBy   User?   @relation(fields: [handledById], references: [id])

  status    String  @default("new") // new|in-progress|done
  isStarred Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
}

// สื่อ/ไฟล์ ที่ผูกกับเอกสารต่างๆ
model MediaAsset {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  ownerType MediaOwnerType
  ownerId   String         @db.ObjectId
  type      MediaType      @default(image)
  url       String
  alt       String?
  tags      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, ownerId])
}

// =========================================
// Join Models (Many-to-Many)
// =========================================

// สำหรับ Public Profile (Credit ผลงาน)
model ProjectMember {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  projectId String @db.ObjectId
  memberId  String @db.ObjectId

  project Project @relation(fields: [projectId], references: [id])
  member  Member  @relation(fields: [memberId], references: [id])

  role String? // บทบาทในโปรเจกต์ (PM, Dev, Designer)
  note String?

  @@unique([projectId, memberId])
}

model ProjectIntern {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  projectId String @db.ObjectId
  internId  String @db.ObjectId

  project Project @relation(fields: [projectId], references: [id])
  intern  Intern  @relation(fields: [internId], references: [id])

  responsibility String?
  note           String?

  @@unique([projectId, internId])
}

// ตารางเก็บตำแหน่งงานที่เปิดรับ (Internship Positions)
model InternshipPosition {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String // ชื่อตำแหน่ง เช่น Frontend Developer
  description String // รายละเอียด
  isOpen      Boolean @default(true) // เปิดรับอยู่หรือไม่

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Partner {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  type        String
  logo        String? // path รูป / URL logo
  website     String?
  facebookUrl String?
  description String?
  status      String  @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Model สำหรับเก็บข้อมูลรูปภาพที่อัพโหลดไปยัง Cloudflare Images
model CloudflareImage {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  cloudflareId String   @unique // ID ที่ Cloudflare ส่งกลับมา
  filename     String // ชื่อไฟล์ต้นฉบับ
  uploadedBy   String? // อาจเชื่อมกับ User ID ถ้าต้องการ
  publicUrl    String // URL สำหรับเข้าถึงรูปภาพ
  variants     String[] // URL ของ variants ต่างๆ (thumbnail, medium, large)

  // Metadata
  width  Int?
  height Int?
  format String? // jpg, png, webp, etc.
  size   Int? // ขนาดไฟล์ (bytes)

  // Reference ไปยัง entity ที่ใช้รูปนี้
  relatedType String? // "project" | "member" | "intern" | "partner" | etc.
  relatedId   String? @db.ObjectId
  fieldName   String? // "cover" | "avatar" | "logo" | "gallery" etc.

  // จัดการ
  isActive Boolean  @default(true)
  tags     String[] // tags สำหรับจัดการรูป

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([relatedType, relatedId])
  @@index([uploadedBy])
}

model NewsletterSubscriber {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  source    String   @default("website") // homepage | contact | etc.
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// =========================================
// PROJECT WORKSPACE (Board / Kanban System)
// =========================================

// บอร์ดหลัก (Workspace Board)
model ProjectBoard {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String  @unique
  description String?
  color       String  @default("#3B82F6")

  // ✅ Visibility (Private/Public)
  visibility Visibility @default(PRIVATE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  columns     BoardColumn[]
  members     BoardMember[]
  activities  BoardActivity[]
  boardLabels BoardLabel[]
}

// คอลัมน์ (To Do / Done)
model BoardColumn {
  id    String  @id @default(auto()) @map("_id") @db.ObjectId
  title String
  order Int
  color String?

  boardId String       @db.ObjectId
  board   ProjectBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  tasks BoardTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// การ์ดงาน (Task)
model BoardTask {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?

  tag       String?
  tagColor  String?
  priority  TaskPriority @default(Medium)
  checklist Int          @default(0)

  order     Int
  dueDate   DateTime?
  startDate DateTime?
  endDate   DateTime?

  comments    Int @default(0)
  attachments Int @default(0)

  columnId String      @db.ObjectId
  column   BoardColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)

  assignees      TaskAssignee[]
  checklistItems ChecklistItem[]
  taskComments   TaskComment[]
  taskMembers    TaskMember[]
  activities     BoardActivity[]

  // timestamp when task was moved to a completed column
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Comments in Task
model TaskComment {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  content String
  author  String
  taskId  String @db.ObjectId
  task    BoardTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Checklist Items in Task
model ChecklistItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  text      String
  isChecked Boolean @default(false)
  order     Int     @default(0)

  taskId String    @db.ObjectId
  task   BoardTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// สมาชิกที่แสดงใน Task (Simple View)
model TaskMember {
  id     String  @id @default(auto()) @map("_id") @db.ObjectId
  name   String
  avatar String?

  taskId String    @db.ObjectId
  task   BoardTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// สมาชิกใน Project Board
model BoardMember {
  id     String  @id @default(auto()) @map("_id") @db.ObjectId
  name   String
  role   String
  avatar String?
  color  String?

  boardId String       @db.ObjectId
  board   ProjectBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
}

// Activity Log
model BoardActivity {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  user   String
  action String
  target String

  boardId String       @db.ObjectId
  board   ProjectBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  projectId String?  @db.ObjectId
  project   Project? @relation(fields: [projectId], references: [id])

  taskId String?    @db.ObjectId
  task   BoardTask? @relation(fields: [taskId], references: [id])

  createdAt DateTime @default(now())
}

// Join Model: Task <-> User (Assignees)
model TaskAssignee {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  taskId String @db.ObjectId
  userId String @db.ObjectId

  task BoardTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
}

// Custom Labels for Board
model BoardLabel {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  color     String // color name: "red", "blue", "green", etc.
  bgColor   String // Tailwind class: "bg-red-100"
  textColor String // Tailwind class: "text-red-700"

  boardId String       @db.ObjectId
  board   ProjectBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([boardId, name])
}