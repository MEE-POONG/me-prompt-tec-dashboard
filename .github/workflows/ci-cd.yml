name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # 1. üß™ Test & Verify Code (‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Push / PR)
  verify-code:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    - name: Install dependencies
      run: npm ci
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    - name: Check Build
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXT_TELEMETRY_DISABLED: 1

  # 2. üê≥ Build Docker & Push (‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Push ‡∏•‡∏á Master ‡πÅ‡∏•‡∏∞ verify-code ‡∏ú‡πà‡∏≤‡∏ô)
  build-push:
    needs: verify-code
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - id: string
      uses: ASzc/change-string-case-action@v1
      with:
        string: ${{ github.event.repository.name }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: chunwarayut/${{ steps.string.outputs.lowercase }}:latest
        build-args: |
          DATABASE_URL=${{ secrets.DATABASE_URL }}

  # 3. üöÄ Deploy to Server (‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Push Image ‡πÄ‡∏™‡∏£‡πá‡∏à)
  deploy:
    needs: build-push
    runs-on: ubuntu-latest
    steps:
      - id: string
        uses: ASzc/change-string-case-action@v1
        with:
          string: ${{ github.event.repository.name }}

      - name: SSH Deploy
        uses: D3rHase/ssh-command-action@v0.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          user: ${{ secrets.SERVER_USER }}
          private_key: ${{ secrets.SSH_KEY }}
          # ‡∏™‡∏±‡πà‡∏á Server: Pull -> Stop -> Remove -> Run -> Prune
          command: |
            echo "‚¨áÔ∏è Pulling latest image..."
            # Force remove old image to ensure we get the fresh layer
            docker rmi chunwarayut/${{ steps.string.outputs.lowercase }}:latest || true
            docker pull chunwarayut/${{ steps.string.outputs.lowercase }}:latest
            
            echo "üõë Stopping old container..."
            docker stop ${{ steps.string.outputs.lowercase }} || true
            docker rm ${{ steps.string.outputs.lowercase }} || true
            
            echo "üöÄ Starting new container..."
            docker run --name ${{ steps.string.outputs.lowercase }} \
              --label io.portainer.accesscontrol.teams=discord \
              --restart=always -d -p 7077:3000 \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e EXT_PUBLIC_SOCKET_URL="${{ secrets.EXT_PUBLIC_SOCKET_URL }}" \
              -e REDIS_URL="${{ secrets.REDIS_URL }}" \
              -e NODE_ENV="production" \
              -e BASE_URL="${{ secrets.BASE_URL }}" \
              -e NEXT_PUBLIC_BASE_URL="${{ secrets.NEXT_PUBLIC_BASE_URL }}" \
              -e CLOUDFLARE_KEY="${{ secrets.CLOUDFLARE_KEY }}" \
              -e CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
              -e CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -e MAIL_USER="${{ secrets.MAIL_USER }}" \
              -e MAIL_PASS="${{ secrets.MAIL_PASS }}" \
              --memory=512m --memory-swap=512m --cpus=1.5 \
              --log-opt max-size=10m --log-opt max-file=3 \
              chunwarayut/${{ steps.string.outputs.lowercase }}:latest
              
            echo "üßπ Cleaning up old images..."
            docker image prune -a -f
