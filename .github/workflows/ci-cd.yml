name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # 1. üß™ Test & Verify Code (‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Push / PR)
  verify-code:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js 20
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'npm'
    - name: Install dependencies
      run: npm ci
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    - name: Check Build
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXT_TELEMETRY_DISABLED: 1

  # 2. üê≥ Build Docker & Push (‡∏£‡∏±‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Push ‡∏•‡∏á Master ‡πÅ‡∏•‡∏∞ verify-code ‡∏ú‡πà‡∏≤‡∏ô)
  build-push:
    needs: verify-code
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Convert repository name to lowercase
      id: string
      run: echo "lowercase=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: |
          chunwarayut/${{ steps.string.outputs.lowercase }}:latest
          chunwarayut/${{ steps.string.outputs.lowercase }}:${{ github.run_id }}
        build-args: |
          DATABASE_URL=${{ secrets.DATABASE_URL }}
        no-cache: true

  # 3. üöÄ Deploy to Server (‡∏£‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Push Image ‡πÄ‡∏™‡∏£‡πá‡∏à)
  deploy:
    needs: build-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Convert repository name to lowercase
        id: string
        run: echo "lowercase=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: SSH Deploy
        uses: D3rHase/ssh-command-action@v0.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          user: ${{ secrets.SERVER_USER }}
          private_key: ${{ secrets.SSH_KEY }}
          command: |
            set -e
            TAG="${{ github.run_id }}"
            
            echo "‚¨áÔ∏è Pulling image with tag: $TAG"
            # Remove old container and image to avoid using cache
            docker stop me-prompt-tec-dashboard || true
            docker rm me-prompt-tec-dashboard || true
            
            # Pull new image
            docker pull chunwarayut/me-prompt-tec-dashboard:$TAG
            
            echo "üñºÔ∏è Current images on server:"
            docker images | grep me-prompt-tec-dashboard
            
            echo "üöÄ Starting new container..."
            docker run --name me-prompt-tec-dashboard \
              --label io.portainer.accesscontrol.teams=discord \
              --restart=always -d -p 7077:3000 \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e EXT_PUBLIC_SOCKET_URL="${{ secrets.EXT_PUBLIC_SOCKET_URL }}" \
              -e REDIS_URL="${{ secrets.REDIS_URL }}" \
              -e NODE_ENV="production" \
              -e BASE_URL="${{ secrets.BASE_URL }}" \
              -e NEXT_PUBLIC_BASE_URL="${{ secrets.NEXT_PUBLIC_BASE_URL }}" \
              -e CLOUDFLARE_KEY="${{ secrets.CLOUDFLARE_KEY }}" \
              -e CLOUDFLARE_ACCOUNT_ID="${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" \
              -e CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -e MAIL_USER="${{ secrets.MAIL_USER }}" \
              -e MAIL_PASS="${{ secrets.MAIL_PASS }}" \
              --memory=512m --memory-swap=512m --cpus=1.5 \
              --log-opt max-size=10m --log-opt max-file=3 \
              chunwarayut/me-prompt-tec-dashboard:$TAG
            
            # Verify running
            sleep 5
            docker ps | grep me-prompt-tec-dashboard
            
            echo "üßπ Cleaning up old images..."
            docker image prune -a -f
            
            echo "‚úÖ Deployment successful with tag: $TAG"

